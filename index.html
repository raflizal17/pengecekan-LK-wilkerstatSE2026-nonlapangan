<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengecekan Format LK Hasil Pengolahan Muatan Wilkerstat Nonlapangan SE2026</title>
    <style>
        /* CSS tetap sama seperti sebelumnya */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        
        h2 {
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            background-color: #ecf0f1;
            cursor: pointer;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: block;
            margin: 20px auto;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .result-section {
            margin-top: 30px;
            display: none;
        }
        
        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background-color: #d5f4e6;
            border-left: 5px solid #2ecc71;
        }
        
        .error {
            background-color: #fadbd8;
            border-left: 5px solid #e74c3c;
        }
        
        .warning {
            background-color: #fef9e7;
            border-left: 5px solid #f39c12;
        }
        
        .result-item {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .result-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .loading {
            text-align: center;
            display: none;
            margin: 20px 0;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .instructions {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #2980b9;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .error-details {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            display: none;
        }
        
        .toggle-details {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 5px;
            display: inline-block;
        }

        .doc-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }

        .doc-link:hover {
            text-decoration: underline;
        }

        #downloadButton {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            display: none; /* Awalnya disembunyikan */
            margin: 20px auto;
        }
        
        #downloadButton:hover {
            background-color: #219a52;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pengecekan Format LK Hasil Pengolahan Muatan Wilkerstat Nonlapangan SE2026</h1>
        
        <div class="instructions">
            <h3>Petunjuk Penggunaan:</h3>
            <ul>
                <li>Upload file LK Hasil Pengolahan Muatan (format Excel .xlsx)</li>
                <li>Upload file Master SLS 2025_1 (format Excel .xlsx)</li>
                <li>Masukkan kode kabupaten/kota (contoh: 1101)</li>
                <li>Klik tombol "Cek Format" untuk memulai pengecekan</li>
                <li>Hasil pengecekan akan ditampilkan di bagian bawah</li>
                <li>Klik tombol "Download File yang Dikoreksi" untuk perbaikan digit idsubsls</li>
                <li><strong>Dokumentasi Metadata:</strong> <a href="http://s.bps.go.id/metadata_LK_wilkerstatSE2026_nonlap" target="_blank" class="doc-link">Klik di sini untuk melihat dokumentasi metadata lengkap</a></li>
            </ul>
        </div>
        
        <div class="form-section">
            <h2>Input Data</h2>
            
            <div class="input-group">
                <label for="lkFile">File LK Hasil Pengolahan Muatan:</label>
                <input type="file" id="lkFile" accept=".xlsx">
            </div>
            
            <div class="input-group">
                <label for="masterFile">File Master SLS 2025 Semester I:</label>
                <input type="file" id="masterFile" accept=".xlsx">
            </div>
            
            <div class="input-group">
                <label for="kodeKab">Kode Kabupaten/Kota (XXYY):</label>
                <input type="text" id="kodeKab" placeholder="Contoh: 1101" maxlength="4">
            </div>
            
            <button id="checkButton">Cek Format</button>
        </div>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Memproses file, harap tunggu...</p>
        </div>
        
        <div class="result-section" id="resultSection">
            <h2>Hasil Pengecekan</h2>
            
            <div class="result-box" id="fileCheckResult">
                <h3>Pengecekan File</h3>
                <div id="fileCheckDetails"></div>
            </div>
            
            <div class="result-box" id="variableCheckResult">
                <h3>Pengecekan Nama Variabel</h3>
                <div id="variableCheckDetails"></div>
            </div>
            
            <div class="result-box" id="dataTypeCheckResult">
                <h3>Pengecekan Tipe Data dan Kelengkapan Data</h3>
                <div id="dataTypeCheckDetails"></div>
            </div>
            
            <div class="result-box" id="anomalyCheckResult">
                <h3>Pengecekan Anomali Data</h3>
                <div id="anomalyCheckDetails"></div>
            </div>
            
            <div class="result-box" id="masterCheckResult">
                <h3>Pengecekan Master Wilayah</h3>
                <div id="masterCheckDetails"></div>
            </div>
            
            <div id="summaryTable"></div>
            
            <!-- TOMBOL DOWNLOAD DIPINDAH KE SINI -->
            <div style="text-align: center; margin-top: 30px;">
                <button id="downloadButton" style="display: none; background-color: #27ae60; padding: 12px 25px; font-size: 16px;">
                    Download File yang Dikoreksi
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Metadata variabel yang benar
        const correctMetadata = [
            { variable: 'id', label: 'frs id', type: 'integer', required: true },
            { variable: 'semester', label: 'semester', type: 'character', required: true },
            { variable: 'idsubsls', label: 'idsubsls 16 digit karakter angka', type: 'character', required: true, length: 16 },
            { variable: 'nmsls', label: 'nama sls', type: 'character', required: true },
            { variable: 'nama_ketua', label: 'nama ketua SLS', type: 'character', required: false },
            { variable: 'jenis', label: 'jenis SLS', type: 'character', required: true },
            { variable: 'kdprov', label: 'kode provinsi', type: 'character', required: true, length: 2 },
            { variable: 'kdkab', label: 'kode kabupaten/kota', type: 'character', required: true, length: 2 },
            { variable: 'kdkec', label: 'kode kecamatan', type: 'character', required: true, length: 3 },
            { variable: 'kddesa', label: 'kode desa/kelurahan', type: 'character', required: true, length: 3 },
            { variable: 'kdsls', label: 'kode sls/nonsls', type: 'character', required: true, length: 4 },
            { variable: 'kdsubsls', label: 'kode subsls', type: 'character', required: true, length: 2 },
            { variable: 'klas', label: 'klasifikasi urban rural', type: 'integer', required: true },
            { variable: 'nmprov', label: 'nama provinsi', type: 'character', required: true },
            { variable: 'nmkab', label: 'nama kabupaten/kota', type: 'character', required: true },
            { variable: 'nmkec', label: 'nama kecamatan', type: 'character', required: true },
            { variable: 'nmdesa', label: 'nama kelurahan/desa', type: 'character', required: true },
            { variable: 'kk', label: 'jumlah KK', type: 'integer', required: true },
            { variable: 'btt', label: 'Jumlah BTT', type: 'integer', required: true },
            { variable: 'bttk', label: 'Jumlah BTT Kosong', type: 'integer', required: true },
            { variable: 'bku', label: 'Jumlah BKU', type: 'integer', required: true },
            { variable: 'bbtt_nonusaha', label: 'Jumlah BBTT Non Usaha', type: 'integer', required: true },
            { variable: 'usaha', label: 'Jumlah Perkiraan Usaha', type: 'integer', required: true },
            { variable: 'muatan', label: 'Total Muatan', type: 'integer', required: true },
            { variable: 'nm_ekonomi', label: 'Nama Wilayah Konsentrasi Ekonomi', type: 'character', required: false },
            { variable: 'shift', label: 'Jumlah Shift', type: 'character', required: false },
            { variable: 'jam_operasional', label: 'Jam Operasional', type: 'character', required: false },
            { variable: 'contact_person', label: 'Contact Person', type: 'character', required: false },
            { variable: 'dominan', label: 'muatan dominan sls', type: 'integer', required: true },
            { variable: 'berubah_batas', label: 'Apakah terdapat perubahan batas', type: 'integer', required: true }
        ];
        
        let masterWilayahData = [];
        
        // VARIABEL BARU UNTUK FITUR DOWNLOAD
        let correctedData = null;
        let correctedWorkbook = null;
        
        // VARIABEL BARU: Untuk melacak apakah ada variabel idsls yang dikoreksi
        let idslsCorrected = false;
        
        // FUNGSI BARU: Koreksi variabel idsls menjadi idsubsls
        function koreksiVariabelIdsls(jsonData) {
            if (!jsonData || jsonData.length < 2) return jsonData;
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            // Cek apakah ada variabel idsls di headers
            const idslsIndex = headers.indexOf('idsls');
            
            if (idslsIndex !== -1) {
                // Ubah nama variabel idsls menjadi idsubsls
                headers[idslsIndex] = 'idsubsls';
                idslsCorrected = true;
                
                console.log(`✅ Variabel 'idsls' dikoreksi menjadi 'idsubsls'`);
            }
            
            return [headers, ...dataRows];
        }
        
        // FUNGSI BARU: Koreksi idsubsls 14 digit - PERBAIKAN DI SINI
        function koreksiIdsubsls14Digit(jsonData) {
            if (!jsonData || jsonData.length < 2) return jsonData;
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            const idsubslsIndex = headers.indexOf('idsubsls');
            const kdsubslsIndex = headers.indexOf('kdsubsls');
            
            if (idsubslsIndex === -1) return jsonData;
            
            let dikoreksiCount = 0;
            const dataTerkoreksi = [];
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = [...dataRows[i]];
                
                if (row.length > idsubslsIndex) {
                    const idsubsls = row[idsubslsIndex];
                    
                    // PERBAIKAN: Cek jika idsubsls 14 digit dan kdsubsls tidak kosong
                    if (idsubsls && idsubsls.toString().length === 14 && /^\d+$/.test(idsubsls.toString())) {
                        let kdsubsls = '';
                        
                        // Cek jika kdsubsls ada dan tidak kosong
                        if (kdsubslsIndex !== -1 && row.length > kdsubslsIndex) {
                            kdsubsls = row[kdsubslsIndex] ? row[kdsubslsIndex].toString() : '';
                        }
                        
                        // PERBAIKAN: Jika kdsubsls tidak kosong, gabungkan saja
                        if (kdsubsls && kdsubsls.trim() !== '') {
                            // Pastikan kdsubsls 2 digit
                            if (kdsubsls.length === 2 && /^\d+$/.test(kdsubsls)) {
                                row[idsubslsIndex] = idsubsls.toString() + kdsubsls;
                                dikoreksiCount++;
                                console.log(`✅ Dikoreksi idsubsls: ${idsubsls} + ${kdsubsls} = ${idsubsls + kdsubsls}`);
                            } else if (kdsubsls.length === 1 && /^\d+$/.test(kdsubsls)) {
                                // Jika hanya 1 digit, tambahkan 0 di depan
                                row[idsubslsIndex] = idsubsls.toString() + '0' + kdsubsls;
                                dikoreksiCount++;
                                console.log(`✅ Dikoreksi idsubsls: ${idsubsls} + 0${kdsubsls} = ${idsubsls + '0' + kdsubsls}`);
                            }
                        } else {
                            // Jika kdsubsls kosong, baru tambahkan '00'
                            row[idsubslsIndex] = idsubsls.toString() + '00';
                            
                            // Koreksi kdsubsls jika kolom ada
                            if (kdsubslsIndex !== -1 && row.length > kdsubslsIndex) {
                                row[kdsubslsIndex] = '00';
                            }
                            
                            dikoreksiCount++;
                        }
                    }
                }
                dataTerkoreksi.push(row);
            }
            
            if (dikoreksiCount > 0) {
                console.log(`✅ Dikoreksi ${dikoreksiCount} record idsubsls 14 digit`);
            }
            
            return [headers, ...dataTerkoreksi];
        }

        // FUNGSI BARU: Koreksi tipe data klas menjadi integer
        function koreksiTipeDataKlas(jsonData) {
            if (!jsonData || jsonData.length < 2) return jsonData;
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            const klasIndex = headers.indexOf('klas');
            
            if (klasIndex === -1) return jsonData;
            
            let dikoreksiCount = 0;
            const dataTerkoreksi = [];
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = [...dataRows[i]];
                
                if (row.length > klasIndex) {
                    const klasValue = row[klasIndex];
                    
                    // Jika nilai klas bukan integer, konversi ke integer
                    if (klasValue !== null && klasValue !== undefined && klasValue !== '') {
                        const intValue = parseInt(klasValue);
                        if (!isNaN(intValue) && intValue.toString() !== klasValue.toString()) {
                            row[klasIndex] = intValue;
                            dikoreksiCount++;
                            console.log(`✅ Dikoreksi klas: "${klasValue}" -> ${intValue}`);
                        }
                    }
                }
                dataTerkoreksi.push(row);
            }
            
            if (dikoreksiCount > 0) {
                console.log(`✅ Dikoreksi ${dikoreksiCount} record tipe data klas`);
            }
            
            return [headers, ...dataTerkoreksi];
        }

        document.getElementById('checkButton').addEventListener('click', function() {
            const lkFile = document.getElementById('lkFile').files[0];
            const masterFile = document.getElementById('masterFile').files[0];
            const kodeKab = document.getElementById('kodeKab').value;
            
            if (!lkFile || !masterFile || !kodeKab) {
                alert('Harap lengkapi semua input!');
                return;
            }
            
            if (kodeKab.length !== 4 || isNaN(kodeKab)) {
                alert('Kode kabupaten/kota harus berupa 4 digit karakter angka!');
                return;
            }
            
            // Reset status koreksi
            idslsCorrected = false;
            
            // Tampilkan loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            
            // Proses file master terlebih dahulu
            processMasterFile(masterFile, lkFile, kodeKab);
        });
        
        function processMasterFile(masterFile, lkFile, kodeKab) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Ambil sheet pertama
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Konversi ke JSON
                    masterWilayahData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Lanjutkan proses file LK
                    processLKFile(lkFile, kodeKab);
                    
                } catch (error) {
                    console.error('Error membaca file master:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    alert('Terjadi kesalahan saat membaca file master. Pastikan file adalah format Excel yang valid.');
                }
            };
            
            reader.readAsArrayBuffer(masterFile);
        }

        function processLKFile(lkFile, kodeKab) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Ambil sheet pertama
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Konversi ke JSON
                    const lkData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // SIMPAN DATA ASLI
                    correctedWorkbook = workbook;
                    correctedData = lkData;
                    
                    // KOREKSI VARIABEL IDSLS JIKA ADA - TETAP DILAKUKAN
                    const dataSebelumKoreksi = JSON.stringify(lkData);
                    correctedData = koreksiVariabelIdsls(lkData);
                    
                    // KOREKSI IDSUBSLS 14 DIGIT - DENGAN PERBAIKAN BARU
                    correctedData = koreksiIdsubsls14Digit(correctedData);
                    
                    // KOREKSI TIPE DATA KLAS - FUNGSI BARU
                    correctedData = koreksiTipeDataKlas(correctedData);
                    
                    const dataSetelahKoreksi = JSON.stringify(correctedData);
                    
                    // TAMPILKAN TOMBOL DOWNLOAD JIKA ADA PERUBAHAN
                    if (dataSebelumKoreksi !== dataSetelahKoreksi || idslsCorrected) {
                        const correctedWorksheet = XLSX.utils.aoa_to_sheet(correctedData);
                        correctedWorkbook.Sheets[firstSheetName] = correctedWorksheet;
                        document.getElementById('downloadButton').style.display = 'block';
                    }
                    
                    // Sembunyikan loading indicator
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    // Tampilkan hasil pengecekan
                    document.getElementById('resultSection').style.display = 'block';
                    
                    // LAKUKAN PENGEcekan DENGAN DATA ASLI (BUKAN YANG SUDAH DIKOREKSI)
                    // agar error tetap muncul untuk idsubsls 14 digit dan variabel idsls
                    checkFileFormat(lkFile, kodeKab);
                    checkVariables(lkData); // DATA ASLI
                    checkDataTypesAndCompleteness(lkData); // DATA ASLI - agar error muncul
                    checkAnomalies(lkData); // DATA ASLI
                    checkMasterWilayah(lkData); // DATA ASLI
                    
                } catch (error) {
                    console.error('Error membaca file LK:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    alert('Terjadi kesalahan saat membaca file LK. Pastikan file adalah format Excel yang valid.');
                }
            };
            
            reader.readAsArrayBuffer(lkFile);
        }
        
        function checkFileFormat(file, kodeKab) {
            const fileCheckDetails = document.getElementById('fileCheckDetails');
            fileCheckDetails.innerHTML = '';
            
            // 1. Cek nama file
            const expectedFileName = `LK Hasil Pengolahan Muatan_Kab ${kodeKab}_result.xlsx`;
            if (file.name === expectedFileName) {
                fileCheckDetails.innerHTML += '<div class="result-item success"><div class="result-title">✓ Nama file sesuai</div><div>Nama file: ' + file.name + '</div></div>';
            } else {
                fileCheckDetails.innerHTML += '<div class="result-item error"><div class="result-title">✗ Nama file tidak sesuai</div><div>Nama file seharusnya: ' + expectedFileName + '</div><div>Nama file saat ini: ' + file.name + '</div></div>';
            }
            
            // 2. Cek format file
            if (file.name.endsWith('.xlsx')) {
                fileCheckDetails.innerHTML += '<div class="result-item success"><div class="result-title">✓ Format file Excel (.xlsx) sesuai</div></div>';
            } else {
                fileCheckDetails.innerHTML += '<div class="result-item error"><div class="result-title">✗ Format file tidak sesuai</div><div>File harus berformat Excel (.xlsx)</div></div>';
            }
        }
        
        function checkVariables(jsonData) {
            const variableCheckDetails = document.getElementById('variableCheckDetails');
            variableCheckDetails.innerHTML = '';
            
            if (!jsonData || jsonData.length === 0) {
                variableCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ File kosong atau tidak valid</div></div>';
                return;
            }
            
            // Ambil header (baris pertama)
            const headers = jsonData[0];
            let errorCount = 0;
            let successCount = 0;
            let extraVariables = [];
            
            // CEK KHUSUS: Deteksi variabel idsls yang seharusnya idsubsls
            let idslsDetected = false;
            let idslsIndex = -1;
            
            headers.forEach(header => {
                const found = correctMetadata.find(metadata => metadata.variable === header);
                if (!found) {
                    // Cek apakah ini variabel idsls yang salah
                    if (header === 'idsls') {
                        idslsDetected = true;
                        idslsIndex = headers.indexOf('header');
                    } else {
                        extraVariables.push(header);
                        errorCount++;
                    }
                }
            });
            
            // TAMPILKAN PESAN KHUSUS JIKA ADA VARIABEL IDSLS
            if (idslsDetected) {
                variableCheckDetails.innerHTML += `
                    <div class="result-item error">
                        <div class="result-title">✗ Variabel 'idsls' ditemukan</div>
                        <div>Variabel 'idsls' seharusnya bernama 'idsubsls'</div>
                        <div><strong>File yang sudah dikoreksi tersedia untuk di-download (tombol di bawah laporan)</strong></div>
                        <div>Variabel 'idsls' akan dikoreksi menjadi 'idsubsls' di file output</div>
                    </div>
                `;
                errorCount++;
            }
            
            // Bandingkan dengan metadata yang benar
            correctMetadata.forEach(metadata => {
                const index = headers.indexOf(metadata.variable);
                let statusClass = '';
                let statusIcon = '';
                let message = '';
                
                if (index === -1) {
                    // Variabel tidak ditemukan
                    // Khusus untuk idsubsls, cek apakah ada idsls sebagai gantinya
                    if (metadata.variable === 'idsubsls' && idslsDetected) {
                        statusClass = 'warning';
                        statusIcon = '⚠';
                        message = 'Variabel ditemukan dengan nama "idsls" (akan dikoreksi menjadi "idsubsls")';
                        successCount++; // Dianggap berhasil karena akan dikoreksi
                    } else {
                        statusClass = 'error';
                        statusIcon = '✗';
                        message = 'Variabel tidak ditemukan dalam file';
                        errorCount++;
                    }
                } else {
                    // Variabel ditemukan
                    statusClass = 'success';
                    statusIcon = '✓';
                    message = `Tipe data: ${metadata.type}`;
                    successCount++;
                }
                
                variableCheckDetails.innerHTML += `
                    <div class="result-item ${statusClass}">
                        <div class="result-title">${statusIcon} ${metadata.variable} - ${metadata.label}</div>
                        <div>${message}</div>
                    </div>
                `;
            });
            
            // Tampilkan variabel tambahan yang tidak ada di metadata
            if (extraVariables.length > 0) {
                variableCheckDetails.innerHTML += `
                    <div class="result-item error">
                        <div class="result-title">✗ Variabel Tambahan yang Tidak Dikenal</div>
                        <div>Terdapat ${extraVariables.length} variabel yang tidak ada dalam metadata:</div>
                        <div class="error-details">${extraVariables.join(', ')}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    </div>
                `;
            }
            
            // Tampilkan ringkasan
            const totalVariablesInFile = headers.length;
            const expectedVariables = correctMetadata.length;
            
            variableCheckDetails.innerHTML += `
                <div class="result-item ${errorCount > 0 ? 'error' : 'success'}">
                    <div class="result-title">Ringkasan Variabel</div>
                    <div>✓ ${successCount} variabel sesuai, ✗ ${errorCount} error</div>
                    <div>Jumlah variabel di file: ${totalVariablesInFile}, Seharusnya: ${expectedVariables}</div>
                    ${totalVariablesInFile !== expectedVariables ? 
                        `<div class="error">PERINGATAN: Jumlah variabel tidak sesuai! File memiliki ${totalVariablesInFile} variabel, seharusnya ${expectedVariables}</div>` : 
                        `<div class="success">✓ Jumlah variabel sesuai</div>`
                    }
                    ${idslsDetected ? 
                        `<div class="warning">⚠ Variabel 'idsls' akan dikoreksi menjadi 'idsubsls' di file output</div>` : 
                        ''
                    }
                </div>
            `;
        }
        
        function checkDataTypesAndCompleteness(jsonData) {
            const dataTypeCheckDetails = document.getElementById('dataTypeCheckDetails');
            dataTypeCheckDetails.innerHTML = '';
            
            if (!jsonData || jsonData.length < 2) {
                dataTypeCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ Tidak ada data untuk dianalisis</div></div>';
                return;
            }
            
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            let totalErrors = 0;
            let totalWarnings = 0;
            let errorDetails = {};
            let warningDetails = {};
            
            // VARIABLE BARU UNTUK DETEKSI IDSUBSLS 14 DIGIT
            let idsubsls14DigitCount = 0;
            let idsubsls14DigitErrors = [];
            
            // VARIABLE BARU UNTUK DETEKSI VARIABEL IDSLS
            let idslsDetected = headers.includes('idsls');
            let idslsIndex = headers.indexOf('idsls');
            
            // VARIABLE BARU UNTUK DETEKSI TIPE DATA KLAS
            let klasNonIntegerCount = 0;
            let klasNonIntegerErrors = [];
            
            // Inisialisasi objek error dan warning details
            correctMetadata.forEach(metadata => {
                errorDetails[metadata.variable] = [];
                warningDetails[metadata.variable] = [];
            });
            
            // Cek setiap variabel metadata
            correctMetadata.forEach(metadata => {
                let colIndex = headers.indexOf(metadata.variable);
                
                // KHUSUS UNTUK IDSUBSLS: Jika tidak ditemukan, cek apakah ada idsls
                if (metadata.variable === 'idsubsls' && colIndex === -1 && idslsDetected) {
                    colIndex = idslsIndex; // Gunakan index idsls sebagai gantinya
                }
                
                // Jika kolom tidak ditemukan, tambahkan error
                if (colIndex === -1) {
                    errorDetails[metadata.variable].push(`KOLOM TIDAK DITEMUKAN: Variabel '${metadata.variable}' tidak ada dalam file LK`);
                    totalErrors++;
                    return; // Skip pengecekan data untuk variabel ini
                }
                
                // Cek setiap baris data untuk variabel ini
                dataRows.forEach((row, rowIndex) => {
                    const rowNum = rowIndex + 2;
                    
                    if (row.length > colIndex) {
                        const value = row[colIndex];
                        
                        // Cek kelengkapan data
                        if (value === null || value === undefined || value === '' || value === 'NULL') {
                            if (metadata.required) {
                                errorDetails[metadata.variable].push(`Baris ${rowNum}: Data kosong`);
                                totalErrors++;
                            } else {
                                if (metadata.variable === 'nama_ketua') {
                                    warningDetails[metadata.variable].push(`Baris ${rowNum}: Data kosong (opsional)`);
                                    totalWarnings++;
                                }
                            }
                        } else {
                            // Cek tipe data untuk data yang tidak kosong
                            if (metadata.type === 'integer') {
                                if (isNaN(Number(value)) || !Number.isInteger(Number(value))) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" bukan integer`);
                                    totalErrors++;
                                    
                                    // Catat khusus untuk klas yang bukan integer
                                    if (metadata.variable === 'klas') {
                                        klasNonIntegerCount++;
                                        klasNonIntegerErrors.push(`Baris ${rowNum}: "${value}" bukan integer`);
                                    }
                                }
                            }
                            
                            // CEK KHUSUS: idsubsls harus 16 digit - PERBAIKAN DI SINI
                            if (metadata.variable === 'idsubsls' && metadata.length) {
                                const valueStr = value.toString();
                                
                                // CEK PANJANG HARUS 16 DIGIT
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka (saat ini ${valueStr.length} digit)`);
                                    totalErrors++;
                                    
                                    // Catat khusus untuk 14 digit
                                    if (valueStr.length === 14 && /^\d+$/.test(valueStr)) {
                                        idsubsls14DigitCount++;
                                        idsubsls14DigitErrors.push(`Baris ${rowNum}: "${value}" harus 16 digit (saat ini 14 digit)`);
                                    }
                                }
                                // CEK HARUS ANGKA SEMUA
                                else if (isNaN(valueStr)) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus terdiri dari karakter angka saja`);
                                    totalErrors++;
                                }
                            }
                            
                            // CEK DIGIT KODE WILAYAH
                            if (metadata.variable === 'kdprov' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            if (metadata.variable === 'kdkab' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            if (metadata.variable === 'kdkec' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            if (metadata.variable === 'kddesa' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            if (metadata.variable === 'kdsls' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            if (metadata.variable === 'kdsubsls' && metadata.length) {
                                const valueStr = value.toString();
                                if (valueStr.length !== metadata.length) {
                                    errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" harus ${metadata.length} digit karakter angka`);
                                    totalErrors++;
                                }
                            }
                            
                            // Cek khusus untuk variabel character
                            if (metadata.type === 'character' && typeof value !== 'string') {
                                errorDetails[metadata.variable].push(`Baris ${rowNum}: "${value}" bukan karakter/string`);
                                totalErrors++;
                            }
                        }
                    } else {
                        // Jika baris tidak memiliki kolom ini (row length pendek)
                        if (metadata.required) {
                            errorDetails[metadata.variable].push(`Baris ${rowNum}: Kolom tidak ada dalam baris ini`);
                            totalErrors++;
                        }
                    }
                });
            });
            
            // TAMPILKAN INFO KOREKSI JIKA ADA VARIABEL IDSLS
            if (idslsDetected) {
                dataTypeCheckDetails.innerHTML += `
                    <div class="result-item warning">
                        <div class="result-title">⚠ Variabel 'idsls' ditemukan (seharusnya 'idsubsls')</div>
                        <div><strong>File yang sudah dikoreksi tersedia untuk di-download (tombol di bawah laporan)</strong></div>
                        <div>Variabel 'idsls' akan dikoreksi menjadi 'idsubsls' di file output</div>
                    </div>
                `;
            }
            
            // TAMPILKAN INFO KOREKSI JIKA ADA IDSUBSLS 14 DIGIT
            if (idsubsls14DigitCount > 0) {
                dataTypeCheckDetails.innerHTML += `
                    <div class="result-item warning">
                        <div class="result-title">⚠ Ditemukan ${idsubsls14DigitCount} idsubsls 14 digit</div>
                        <div><strong>File yang sudah dikoreksi tersedia untuk di-download (tombol di bawah laporan)</strong></div>
                        <div>idsubsls 14 digit akan dikoreksi menjadi 16 digit dengan menggabungkan idsubsls dan kdsubsls</div>
                        <div class="error-details" style="display: none;">
                            <strong>Detail idsubsls 14 digit:</strong><br>
                            ${idsubsls14DigitErrors.join('<br>')}
                        </div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    </div>
                `;
            }
            
            // TAMPILKAN INFO KOREKSI JIKA ADA KLAS BUKAN INTEGER
            if (klasNonIntegerCount > 0) {
                dataTypeCheckDetails.innerHTML += `
                    <div class="result-item warning">
                        <div class="result-title">⚠ Ditemukan ${klasNonIntegerCount} data klas bukan integer</div>
                        <div><strong>File yang sudah dikoreksi tersedia untuk di-download (tombol di bawah laporan)</strong></div>
                        <div>Data klas akan dikonversi otomatis ke integer di file output</div>
                        <div class="error-details" style="display: none;">
                            <strong>Detail klas bukan integer:</strong><br>
                            ${klasNonIntegerErrors.join('<br>')}
                        </div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    </div>
                `;
            }
            
            // Tampilkan hasil pengecekan untuk setiap variabel
            correctMetadata.forEach(metadata => {
                const errors = errorDetails[metadata.variable];
                const warnings = warningDetails[metadata.variable];
                
                if (errors.length > 0) {
                    const isColumnNotFound = errors.some(error => error.includes('KOLOM TIDAK DITEMUKAN'));
                    
                    dataTypeCheckDetails.innerHTML += `
                        <div class="result-item error">
                            <div class="result-title">✗ ${metadata.variable} - ${metadata.label}</div>
                            <div>${isColumnNotFound ? 'Kolom tidak ditemukan dalam file' : `Terdapat ${errors.length} error`}</div>
                            ${errors.length > 0 && !isColumnNotFound ? `
                                <div class="error-details" style="display: none;">${errors.join('<br>')}</div>
                                <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                            ` : ''}
                        </div>
                    `;
                } else if (warnings.length > 0 && metadata.variable === 'nama_ketua') {
                    dataTypeCheckDetails.innerHTML += `
                        <div class="result-item warning">
                            <div class="result-title">⚠ ${metadata.variable} - ${metadata.label}</div>
                            <div>Terdapat ${warnings.length} data kosong (opsional)</div>
                            <div class="error-details" style="display: none;">${warnings.join('<br>')}</div>
                            <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                        </div>
                    `;
                } else {
                    dataTypeCheckDetails.innerHTML += `
                        <div class="result-item success">
                            <div class="result-title">✓ ${metadata.variable} - ${metadata.label}</div>
                            <div>Data lengkap dan tipe sesuai</div>
                        </div>
                    `;
                }
            });
            
            // Tampilkan ringkasan
            dataTypeCheckDetails.innerHTML += `
                <div class="result-item ${totalErrors > 0 ? 'error' : (totalWarnings > 0 ? 'warning' : 'success')}">
                    <div class="result-title">Ringkasan Tipe Data dan Kelengkapan</div>
                    <div>Total error: ${totalErrors}, Total warning: ${totalWarnings}</div>
                    ${idslsDetected ? `<div>Termasuk variabel 'idsls' yang akan dikoreksi menjadi 'idsubsls'</div>` : ''}
                    ${idsubsls14DigitCount > 0 ? `<div>Termasuk ${idsubsls14DigitCount} idsubsls 14 digit yang dapat dikoreksi</div>` : ''}
                    ${klasNonIntegerCount > 0 ? `<div>Termasuk ${klasNonIntegerCount} data klas yang akan dikonversi ke integer</div>` : ''}
                </div>
            `;
        }
        
        function checkAnomalies(jsonData) {
            const anomalyCheckDetails = document.getElementById('anomalyCheckDetails');
            anomalyCheckDetails.innerHTML = '';
            
            if (!jsonData || jsonData.length < 2) {
                anomalyCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ Tidak ada data untuk dianalisis</div></div>';
                return;
            }
            
            // Ambil header dan data
            const headers = jsonData[0];
            const dataRows = jsonData.slice(1);
            
            // Cari indeks kolom yang diperlukan
            const muatanIndex = headers.indexOf('muatan');
            const usahaIndex = headers.indexOf('usaha');
            const bkuIndex = headers.indexOf('bku');
            const kkIndex = headers.indexOf('kk');
            const bttIndex = headers.indexOf('btt');
            const bttkIndex = headers.indexOf('bttk');
            const bbttNonusahaIndex = headers.indexOf('bbtt_nonusaha');
            
            // Cek jika ada kolom yang tidak ditemukan
            const requiredColumns = [
                { name: 'muatan', index: muatanIndex },
                { name: 'usaha', index: usahaIndex },
                { name: 'bku', index: bkuIndex },
                { name: 'kk', index: kkIndex },
                { name: 'btt', index: bttIndex },
                { name: 'bttk', index: bttkIndex },
                { name: 'bbtt_nonusaha', index: bbttNonusahaIndex }
            ];
            
            const missingColumns = requiredColumns.filter(col => col.index === -1);
            
            if (missingColumns.length > 0) {
                anomalyCheckDetails.innerHTML = `
                    <div class="result-item error">
                        <div class="result-title">✗ Tidak dapat melakukan pengecekan anomali</div>
                        <div>Kolom berikut tidak ditemukan: ${missingColumns.map(col => col.name).join(', ')}</div>
                    </div>
                `;
                return;
            }
            
            let anomaly1Errors = []; // usaha >= bku
            let anomaly2Errors = []; // muatan >= max(kk, btt) + bttk + bbtt_nonusaha + usaha
            let anomaly3Errors = []; // muatan > 240
            
            dataRows.forEach((row, index) => {
                if (row.length > Math.max(muatanIndex, usahaIndex, bkuIndex, kkIndex, bttIndex, bttkIndex, bbttNonusahaIndex)) {
                    const muatan = parseInt(row[muatanIndex]) || 0;
                    const usaha = parseInt(row[usahaIndex]) || 0;
                    const bku = parseInt(row[bkuIndex]) || 0;
                    const kk = parseInt(row[kkIndex]) || 0;
                    const btt = parseInt(row[bttIndex]) || 0;
                    const bttk = parseInt(row[bttkIndex]) || 0;
                    const bbttNonusaha = parseInt(row[bbttNonusahaIndex]) || 0;
                    
                    // Anomali 1: usaha >= bku
                    if (usaha < bku) {
                        anomaly1Errors.push(`Baris ${index + 2}: usaha (${usaha}) < bku (${bku})`);
                    }
                    
                    // Anomali 2: muatan >= max(kk, btt) + bttk + bbtt_nonusaha + usaha
                    const maxKKorBTT = Math.max(kk, btt);
                    const total = maxKKorBTT + bttk + bbttNonusaha + usaha;
                    if (muatan < total) {
                        anomaly2Errors.push(`Baris ${index + 2}: muatan (${muatan}) < ${maxKKorBTT} + ${bttk} + ${bbttNonusaha} + ${usaha} = ${total}`);
                    }
                    
                    // Anomali 3: muatan > 240
                    if (muatan > 240) {
                        anomaly3Errors.push(`Baris ${index + 2}: muatan (${muatan}) > 240`);
                    }
                }
            });
            
            // Tampilkan hasil anomali
            anomalyCheckDetails.innerHTML += `
                <div class="result-item ${anomaly1Errors.length === 0 ? 'success' : 'error'}">
                    <div class="result-title">${anomaly1Errors.length === 0 ? '✓' : '✗'} usaha >= bku</div>
                    <div>${anomaly1Errors.length === 0 ? 'Kondisi terpenuhi' : `Terdapat ${anomaly1Errors.length} record dengan usaha < bku`}</div>
                    ${anomaly1Errors.length > 0 ? `
                        <div class="error-details" style="display: none;">${anomaly1Errors.join('<br>')}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    ` : ''}
                </div>
                <div class="result-item ${anomaly2Errors.length === 0 ? 'success' : 'error'}">
                    <div class="result-title">${anomaly2Errors.length === 0 ? '✓' : '✗'} muatan >= maximum(kk atau btt) + bttk + bbtt_nonusaha + usaha</div>
                    <div>${anomaly2Errors.length === 0 ? 'Kondisi terpenuhi' : `Terdapat ${anomaly2Errors.length} record yang tidak memenuhi kondisi`}</div>
                    ${anomaly2Errors.length > 0 ? `
                        <div class="error-details" style="display: none;">${anomaly2Errors.join('<br>')}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    ` : ''}
                </div>
                <div class="result-item ${anomaly3Errors.length === 0 ? 'success' : 'warning'}">
                    <div class="result-title">${anomaly3Errors.length === 0 ? '✓' : '⚠'} muatan > 240</div>
                    <div>${anomaly3Errors.length === 0 ? 'Tidak ada record dengan muatan > 240' : `Terdapat ${anomaly3Errors.length} record dengan muatan > 240`}</div>
                    ${anomaly3Errors.length > 0 ? `
                        <div class="error-details" style="display: none;">${anomaly3Errors.join('<br>')}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                    ` : ''}
                </div>
            `;
        }
                
        function checkMasterWilayah(lkData) {
            const masterCheckDetails = document.getElementById('masterCheckDetails');
            masterCheckDetails.innerHTML = '';
            
            if (!lkData || lkData.length < 2 || !masterWilayahData || masterWilayahData.length < 2) {
                masterCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ Data tidak cukup untuk pengecekan master wilayah</div></div>';
                return;
            }
            
            // Ambil header dari kedua file
            const lkHeaders = lkData[0];
            const masterHeaders = masterWilayahData[0];
            
            // Cari kolom idsubsls di kedua file, bisa idsubsls atau idsls
            let lkIdsubslsIndex = lkHeaders.indexOf('idsubsls');
            if (lkIdsubslsIndex === -1) {
                lkIdsubslsIndex = lkHeaders.indexOf('idsls');
            }
            
            let masterIdsubslsIndex = masterHeaders.indexOf('idsubsls');
            if (masterIdsubslsIndex === -1) {
                masterIdsubslsIndex = masterHeaders.indexOf('idsls');
            }
            
            // Cari kolom kdsubsls di LK
            const lkKdsubslsIndex = lkHeaders.indexOf('kdsubsls');
            
            // Jika kolom idsubsls/idsls tidak ditemukan di salah satu file
            if (lkIdsubslsIndex === -1) {
                masterCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ Kolom idsubsls/idsls tidak ditemukan di file LK</div></div>';
                return;
            }
            
            if (masterIdsubslsIndex === -1) {
                masterCheckDetails.innerHTML = '<div class="result-item error"><div class="result-title">✗ Kolom idsubsls/idsls tidak ditemukan di file Master Wilayah</div></div>';
                return;
            }
            
            // Hitung total records
            const totalLkRecords = lkData.length - 1;
            const totalMasterRecords = masterWilayahData.length - 1;
            
            // DATA UNTUK MASTER WILAYAH
            const masterIdslsSet = new Set(); // 14 digit unique
            const masterIdslsCount = new Map(); // Untuk hitung duplikat 14 digit
            const masterDuplicates14 = []; // Duplikat idsls 14 digit di master
            
            // DATA UNTUK LK
            const lkIdslsSet = new Set(); // 14 digit unique untuk matching
            const lkIdsubsls16Set = new Set(); // 16 digit unique setelah koreksi
            const lkIdsubsls16Count = new Map(); // Untuk hitung duplikat 16 digit di LK
            const lkDuplicates16 = []; // Duplikat idsubsls 16 digit di LK
            
            // Untuk evaluasi matching
            let lkToMasterMatch = 0;
            const lkUnmatched = [];
            let masterToLkMatch = 0;
            const masterUnmatched = [];
            
            // PROSES DATA MASTER WILAYAH
            for (let i = 1; i < masterWilayahData.length; i++) {
                if (masterWilayahData[i].length > masterIdsubslsIndex) {
                    const idsubsls = masterWilayahData[i][masterIdsubslsIndex];
                    if (idsubsls) {
                        const idsubslsStr = idsubsls.toString().trim();
                        // Ambil 14 digit pertama
                        const idsls = idsubslsStr.substring(0, 14);
                        if (idsls.length === 14 && /^\d+$/.test(idsls)) {
                            masterIdslsSet.add(idsls);
                            
                            // Hitung duplikat 14 digit di master
                            if (masterIdslsCount.has(idsls)) {
                                masterIdslsCount.set(idsls, masterIdslsCount.get(idsls) + 1);
                            } else {
                                masterIdslsCount.set(idsls, 1);
                            }
                        }
                    }
                }
            }
            
            // Identifikasi duplikat 14 digit di master
            masterIdslsCount.forEach((count, idsls) => {
                if (count > 1) {
                    masterDuplicates14.push({
                        idsls: idsls,
                        count: count
                    });
                }
            });
            
            // PROSES DATA LK
            for (let i = 1; i < lkData.length; i++) {
                if (lkData[i].length > lkIdsubslsIndex) {
                    const idsubsls = lkData[i][lkIdsubslsIndex];
                    if (idsubsls) {
                        const idsubslsStr = idsubsls.toString().trim();
                        
                        // Ambil 14 digit pertama untuk matching
                        const idsls14Digit = idsubslsStr.substring(0, 14);
                        if (idsls14Digit.length === 14 && /^\d+$/.test(idsls14Digit)) {
                            lkIdslsSet.add(idsls14Digit);
                            
                            // Evaluasi matching LK -> Master (14 digit)
                            if (masterIdslsSet.has(idsls14Digit)) {
                                lkToMasterMatch++;
                            } else {
                                lkUnmatched.push(`Baris ${i + 1}: ${idsubslsStr} (idsls: ${idsls14Digit})`);
                            }
                            
                            // Hitung 16 digit setelah koreksi untuk duplikat di LK
                            let kdsubsls = '';
                            if (lkKdsubslsIndex !== -1 && lkData[i].length > lkKdsubslsIndex) {
                                kdsubsls = lkData[i][lkKdsubslsIndex] ? lkData[i][lkKdsubslsIndex].toString().trim() : '';
                            }
                            
                            // Buat idsubsls 16 digit lengkap
                            let idsubsls16 = '';
                            if (idsubslsStr.length === 16) {
                                idsubsls16 = idsubslsStr;
                            } else if (idsubslsStr.length === 14) {
                                if (kdsubsls && kdsubsls !== '' && kdsubsls.length === 2 && /^\d+$/.test(kdsubsls)) {
                                    idsubsls16 = idsls14Digit + kdsubsls;
                                } else {
                                    idsubsls16 = idsls14Digit + '00';
                                }
                            }
                            
                            if (idsubsls16.length === 16) {
                                lkIdsubsls16Set.add(idsubsls16);
                                
                                // Hitung duplikat 16 digit di LK
                                if (lkIdsubsls16Count.has(idsubsls16)) {
                                    lkIdsubsls16Count.set(idsubsls16, lkIdsubsls16Count.get(idsubsls16) + 1);
                                } else {
                                    lkIdsubsls16Count.set(idsubsls16, 1);
                                }
                            }
                        } else {
                            lkUnmatched.push(`Baris ${i + 1}: ${idsubslsStr} (bukan 14 digit angka)`);
                        }
                    } else {
                        lkUnmatched.push(`Baris ${i + 1}: Data kosong`);
                    }
                }
            }
            
            // Identifikasi duplikat 16 digit di LK
            lkIdsubsls16Count.forEach((count, idsubsls16) => {
                if (count > 1) {
                    lkDuplicates16.push({
                        idsubsls16: idsubsls16,
                        count: count
                    });
                }
            });
            
            // Hitung match dari Master ke LK (14 digit)
            masterIdslsSet.forEach(idsls => {
                if (lkIdslsSet.has(idsls)) {
                    masterToLkMatch++;
                } else {
                    masterUnmatched.push(`${idsls}`);
                }
            });
            
            // Hitung persentase
            const lkMatchPercentage = totalLkRecords > 0 ? Math.round((lkToMasterMatch / totalLkRecords) * 100) : 0;
            const masterMatchPercentage = totalMasterRecords > 0 ? Math.round((masterToLkMatch / totalMasterRecords) * 100) : 0;
            
            // Tampilkan hasil pencocokan
            let resultHTML = '';
            
            // Informasi kolom
            resultHTML += `
                <div class="result-item info" style="background-color: #e8f4fc; border-left: 5px solid #3498db;">
                    <div class="result-title">ℹ Informasi Kolom yang Digunakan</div>
                    <div>Matching dilakukan berdasarkan <strong>idsls (14 digit pertama)</strong></div>
                </div>
            `;
            
            // 1. Duplikat di LK (16 digit)
            if (lkDuplicates16.length > 0) {
                const totalDuplikatRecords16 = lkDuplicates16.reduce((sum, dup) => sum + (dup.count - 1), 0);
                
                resultHTML += `
                    <div class="result-item error">
                        <div class="result-title">✗ Ditemukan ${lkDuplicates16.length} idsubsls duplikat di LK</div>
                        <div>Total records dengan idsubsls duplikat: ${totalDuplikatRecords16}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                        <div class="error-details" style="display: none;">
                            <strong>Detail idsubsls duplikat (16 digit) di LK:</strong><br>
                            ${lkDuplicates16.map(dup => 
                                `idsubsls: ${dup.idsubsls16} (${dup.count}x)`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            } else {
                resultHTML += `
                    <div class="result-item success">
                        <div class="result-title">✓ Tidak ada idsubsls duplikat di LK</div>
                        <div>Semua idsubsls (16 digit) unik di file LK</div>
                    </div>
                `;
            }
            
            // 2. Duplikat di Master (14 digit)
            if (masterDuplicates14.length > 0) {
                const totalDuplikatRecords14 = masterDuplicates14.reduce((sum, dup) => sum + (dup.count - 1), 0);
                
                resultHTML += `
                    <div class="result-item error">
                        <div class="result-title">✗ Ditemukan ${masterDuplicates14.length} idsls duplikat di Master</div>
                        <div>Total records dengan idsls duplikat: ${totalDuplikatRecords14}</div>
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan detail</span>
                        <div class="error-details" style="display: none;">
                            <strong>Detail idsls duplikat (14 digit) di Master:</strong><br>
                            ${masterDuplicates14.map(dup => 
                                `idsls: ${dup.idsls} (${dup.count}x)`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            } else {
                resultHTML += `
                    <div class="result-item success">
                        <div class="result-title">✓ Tidak ada idsls duplikat di Master</div>
                        <div>Semua idsls (14 digit) unik di master wilayah</div>
                    </div>
                `;
            }
            
            // 3. Pencocokan LK -> Master
            resultHTML += `
                <div class="result-item ${lkMatchPercentage === 100 ? 'success' : (lkMatchPercentage >= 95 ? 'warning' : 'error')}">
                    <div class="result-title">${lkMatchPercentage === 100 ? '✓' : (lkMatchPercentage >= 95 ? '⚠' : '✗')} Matching dari LK ke Master</div>
                    <div><strong>Berdasarkan idsls (14 digit pertama)</strong></div>
                    <div>${lkToMasterMatch} dari ${totalLkRecords} records di LK ditemukan di master (${lkMatchPercentage}%)</div>
                    ${lkUnmatched.length > 0 ? `
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan ${lkUnmatched.length} records yang tidak ditemukan di master</span>
                        <div class="error-details" style="display: none;">
                            <strong>Records di LK yang tidak ada di master:</strong><br>
                            ${lkUnmatched.join('<br>')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // 4. Pencocokan Master -> LK
            resultHTML += `
                <div class="result-item ${masterMatchPercentage === 100 ? 'success' : (masterMatchPercentage >= 95 ? 'warning' : 'error')}">
                    <div class="result-title">${masterMatchPercentage === 100 ? '✓' : (masterMatchPercentage >= 95 ? '⚠' : '✗')} Matching dari Master ke LK</div>
                    <div><strong>Berdasarkan idsls (14 digit pertama)</strong></div>
                    <div>${masterToLkMatch} dari ${totalMasterRecords} idsls di master ditemukan di LK (${masterMatchPercentage}%)</div>
                    ${masterUnmatched.length > 0 ? `
                        <span class="toggle-details" onclick="toggleErrorDetails(this)">Tampilkan ${masterUnmatched.length} idsls yang tidak ditemukan di LK</span>
                        <div class="error-details" style="display: none;">
                            <strong>Idsls di master yang tidak ada di LK:</strong><br>
                            ${masterUnmatched.join('<br>')}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // 5. RINGKASAN PENGECOKAN - SESUAI FORMAT YANG DIINGINKAN
            resultHTML += `
                <div class="result-item ${lkMatchPercentage === 100 && masterMatchPercentage === 100 && lkDuplicates16.length === 0 && masterDuplicates14.length === 0 ? 'success' : 'warning'}">
                    <div class="result-title">📊 Ringkasan Matching</div>
                    <div>Total records di LK: ${totalLkRecords}</div>
                    <div>Total records di Master: ${totalMasterRecords}</div>
                    <br>
                    <div>Unique idsls (14 digit) di LK: ${lkIdslsSet.size}</div>
                    <div>Unique idsubsls (16 digit) di LK: ${lkIdsubsls16Set.size}</div>
                    <div>Unique idsls (14 digit) di Master: ${masterIdslsSet.size}</div>
                    <br>
                    <div>Duplikat idsubsls (16 digit) di LK: ${lkDuplicates16.length}</div>
                    <div>Duplikat idsls (14 digit) di Master: ${masterDuplicates14.length}</div>
                    <br>
                    <div>Match LK → Master: ${lkToMasterMatch}/${totalLkRecords} (${lkMatchPercentage}%)</div>
                    <div>Match Master → LK: ${masterToLkMatch}/${totalMasterRecords} (${masterMatchPercentage}%)</div>
                    <br>
                    ${lkDuplicates16.length > 0 ? 
                        `<div class="error">❌ Ditemukan ${lkDuplicates16.length} idsubsls duplikat di file LK</div>` : 
                        `<div class="success">✓ Tidak ada idsubsls duplikat di file LK</div>`
                    }
                    ${masterDuplicates14.length > 0 ? 
                        `<div class="error">❌ Ditemukan ${masterDuplicates14.length} idsls duplikat di master wilayah</div>` : 
                        `<div class="success">✓ Tidak ada idsls duplikat di master wilayah</div>`
                    }
                    ${lkMatchPercentage === 100 && masterMatchPercentage === 100 ? 
                        `<div class="success">✓ Semua idsls cocok sempurna antara LK dan master wilayah</div>` : 
                        `<div class="warning">⚠ Ada ketidaksesuaian antara LK dan master wilayah</div>`
                    }
                </div>
            `;
            
            masterCheckDetails.innerHTML = resultHTML;
        }

        // Fungsi untuk toggle detail error - VERSI FINAL
        function toggleErrorDetails(element) {
            // Cari parent result-item terdekat
            const resultItem = element.closest('.result-item');
            if (!resultItem) return;
            
            // Cari elemen error-details di dalam result-item
            const errorDetails = resultItem.querySelector('.error-details');
            if (!errorDetails) return;
            
            // Toggle display
            if (errorDetails.style.display === 'none' || errorDetails.style.display === '') {
                errorDetails.style.display = 'block';
                element.textContent = 'Sembunyikan detail';
            } else {
                errorDetails.style.display = 'none';
                element.textContent = 'Tampilkan detail';
            }
        }
        
        // FUNGSI BARU: Download file yang dikoreksi
        function downloadCorrectedFile() {
            if (!correctedWorkbook) {
                alert('Tidak ada data yang tersedia untuk diunduh');
                return;
            }
            
            try {
                // Generate nama file baru
                const originalFileName = document.getElementById('lkFile').files[0].name;
                const fileNameWithoutExt = originalFileName.replace('.xlsx', '');
                const newFileName = `${fileNameWithoutExt}_corrected.xlsx`;
                
                // Konversi workbook ke binary string
                const wbout = XLSX.write(correctedWorkbook, { bookType: 'xlsx', type: 'binary' });
                
                // Buat blob dan download
                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = newFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert(`✅ File berhasil diunduh: ${newFileName}`);
            } catch (error) {
                console.error('Error downloading file:', error);
                alert('Terjadi kesalahan saat mengunduh file');
            }
        }
        
        // FUNGSI HELPER: Konversi string ke array buffer
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }
        
        // EVENT LISTENER BARU: Untuk tombol download
        document.getElementById('downloadButton').addEventListener('click', downloadCorrectedFile);
    </script>
</body>
</html>
